<div class="card my-2 w-100">
  <div class="card-body table-responsive">
    <div class="row align-items-center">
      <h2 class="card-title col-10 fs-5">
        <%= "#{@options[:count]}." if @options[:count].present?%>
        <%= title %>
      </h2>
      <%= csv_download_link if bulk_export.csv.attached?%>
    </div>
    <table class="table table-striped table-responsive">
      <thead>
      <tr class="text-center">
        <th scope="col">State</th>
        <th scope="col">Duration</th>
        <th scope="col">Generated By</th>
        <th scope="col">Generated At</th>
        <th scope="col" class="visually-hidden">Regenerate</th>
        <th scope="col" class="visually-hidden">Cancel</th>
        <th scope="col" class="visually-hidden">Delete</th>
      </tr>
      </thead>
      <tbody>
      <tr class="text-center">
        <td><%= bulk_export.state.titleize %></td>
        <td><%= duration_in_words %></td>
        <td><%= bulk_export.created_by.email %></td>
        <td><%= bulk_export.generated_at&.to_fs(:display) %></td>
        <td>
          <% if can_regenerate?%>
            <%= render Form::Component.new(name: 'regenerate_bulk_export', url: regenerate_bulk_export_path(@bulk_export), method: :get) do |component| %>
              <% component.with_submit('Regenerate Export', confirm: 'Do you really want to regenerate this bulk export?', variant: 'outline-primary') %>
            <% end %>
          <% end %>
        </td>
        <td>
          <% if can_cancel? %>
            <%= render Form::Component.new(name: 'cancel_bulk_export', url: cancel_bulk_export_path(@bulk_export), method: :get) do |component| %>
              <% component.with_submit('Cancel Export', confirm: 'Do you really want to cancel this bulk export?', variant: 'outline-secondary') %>
            <% end %>
          <% end %>
        </td>
        <td>
          <% if can_delete? %>
            <%= render Form::Component.new(name: 'delete_bulk_export', url: bulk_export_path(@bulk_export), method: :delete) do |component| %>
              <% component.with_submit('Delete Export', confirm: 'Do you really want to delete this bulk export?', variant: 'danger') %>
            <% end %>
          <% end %>
        </td>
      </tr>
    </table>
    <h5 class="card-text">Search Parameters</h5>
      <div class="row m-auto">
        <div class="col-12 col-md-4 col-lg-2">
          <div class="row mb-2 text-left">
          <strong>Sort</strong>
          </div>
          <div class="row">
            <div class="col-6 offset-6 col-md-8 offset-md-0 ">
              <%= "#{bulk_export.search_params.dig('sort', 'field')}," if bulk_export.search_params.dig('sort', 'field')  %>
              <%= bulk_export.search_params.dig('sort', 'direction') %></div>
          </div>
        </div>
        <div class="col-12 col-md-8 col-lg-5">
          <div class="row mb-2 text-left">
          <strong>Search</strong>
          </div>
          <div class="row">
            <div class="col-6 col-md-4 fw-bold">
              <%= 'All' if bulk_export.search_params.dig('search', 'all').present? %>
            </div>
            <div class="col-6 col-md-8">
              <%= bulk_export.search_params.dig('search', 'all') %>
            </div>
          </div>
          <div class="row">
            <div class="col-6 col-md-4 fw-bold">
              <%= 'Fielded' if bulk_export.search_params.dig('search', 'fielded').present? %>
            </div>
            <div class="col-6 col-md-8">
              <ul class="list-group">
                <% bulk_export.search_params.dig('search', 'fielded')&.each do |fielded| %>
                  <li class="list-group-item border-0 p-0" style=background:none>
                    <%= "#{fielded.dig("opr")} #{fielded.dig("field")}: '#{fielded.dig("term")}'"%>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-5">
          <div class="row mb-2 text-left">
          <strong>Filter(s)</strong>
          </div>
          <% bulk_export.search_params.dig('filter')&.each do |key, value| %>
            <% if value.present? %>
              <div class="row">
                <div class="col-6 col-md-4 fw-bold"> <%= key.titleize%></div>
                <% if value.is_a?(Array) %>
                  <div class="col-6 col-md-8">
                  <ul class="list-group">
                  <%value.each do |element| %>
                    <li class="list-group-item border-0 p-0" style=background:none>
                      <%= element %>
                    </li>
                  <% end %>
                  </ul>
                  </div>
                <% else %>
                <div class="col-6 col-md-8"><%=value %></div>
                  <% end  %>
              </div>
            <% end  %>
          <% end %>
        </div>
      </div>
  </div>
  <% if bulk_export.process_errors? %>
  <div class="card-footer bg-warning text-dark">
    <%= "Error: #{bulk_export.process_errors.first}" %>
  </div>
    <% end %>
</div>
